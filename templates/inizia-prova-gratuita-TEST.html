<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
        name="viewport" />
    <title>Dashboard - Analytics | TeamTime</title>
    <meta content="" name="description" />
    <!-- FAVICON -->
    <link rel="icon" type="image/png" sizes="96x96" href="/static/img/favicon/favicon-96x96.png" />
    <link rel="icon" type="image/svg+xml" href="/static/img/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/static/img/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/static/img/favicon/apple-touch-icon.png" />
    <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&amp;display=swap"
        rel="stylesheet" />
    <!-- Icons. Uncomment required icon fonts -->
    <link href="/static/vendor/fonts/boxicons.css" rel="stylesheet" />
    <!-- Core CSS -->
    <link class="template-customizer-core-css" href="/static/vendor/css/core.css" rel="stylesheet" />
    <link class="template-customizer-theme-css" href="/static/vendor/css/theme-default.css" rel="stylesheet" />
    <link href="/static/css/demo.css" rel="stylesheet" />
    <!-- Vendors CSS -->
    <link href="/static/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" rel="stylesheet" />
    <link href="/static/vendor/libs/apex-charts/apex-charts.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Page CSS -->
    <!-- Helpers -->
    <script src="/static/vendor/js/helpers.js"></script>
    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Config: Mandatory theme config file containing global vars & default theme options -->
    <script src="/static/js/config.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">



    <style>
        /* Sfondo immagine con opacit√† */
        .modal-content {
            min-height: 400px;
            height: 660px;
            /* forza l'altezza fissa */
            position: relative;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.95);
        }
    
    
        .modal-content::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("/static/img/img/img.jpg");
            background-size: cover;
            background-position: center;
            z-index: 1;
        }
    
        /* Tutto il contenuto sopra l'immagine */
        .modal-body,
        .modal-header,
        .modal-footer {
            position: relative;
            z-index: 2;
        }
    
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #999;
            font-size: 0.85rem;
        }
    
        .step .circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid red;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
    
        .step.active .circle {
            background-color: red;
            color: white;
            border: none;
        }
    
        .step.current .circle {
            color: red;
            background-color: white;
            border: 1px solid red;
        }
    
        .step .label {
            white-space: nowrap;
        }
    
        .divider {
            height: 1px;
            flex: 1;
            background-color: #ddd;
            margin-top: 12px;
        }
    
        .StripeElement {
            font-size: 16px;
            font-family: 'Public Sans', sans-serif;
            color: #495057;
            background-color: white;
            padding: 10px 12px;
        }
    
        .StripeElement--focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
        }
    
        .stripe-secure-text {
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            color: #333;
            letter-spacing: 0.3px;
        }
    
        /* Fix per il box riepilogo che esce dal contenitore */
        .riepilogo-box-fix,
        .riepilogo-box-fix * {
            box-sizing: border-box !important;
            word-break: break-word;
        }
    
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }
    
            #step1 {
                flex-direction: column !important;
                padding: 1rem;
            }
    
            #step1>div {
                width: 100% !important;
                margin-bottom: 1rem;
            }
    
            #step2 {
                flex-direction: column !important;
                padding: 1rem;
            }
    
            #step2>div {
                width: 100% !important;
                margin-bottom: 1rem;
            }
    
            /* Miglioramento responsivit√† step-1 modal */
            #popup .modal-dialog {
                max-width: 100vw;
                margin: 0;
            }
    
            #popup .modal-content {
                border-radius: 0;
                min-height: 100vh;
            }
    
            #boxStep1 {
                max-width: 98vw !important;
                min-width: 0 !important;
                width: 100vw !important;
                border-radius: 0 0 12px 12px !important;
                padding: 2.2rem 1.1rem !important;
                margin: 0 auto !important;
            }
    
            #step1 {
                min-height: 100vh;
                overflow-y: auto;
                align-items: flex-start !important;
                justify-content: flex-start !important;
            }
        }
    </style>
</head>

<body>

    <!-- ‚úÖ MODAL -->
    <div id="popup" class="modal fade show" tabindex="-1" style="display:none;" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content shadow rounded-4">
                <button type="button" class="btn-close position-absolute" style="top: 16px; right: 16px;"
                    aria-label="Close" onclick="closePopup()"></button>
                <form id="step1" class="modal-body" novalidate>
                    <h5 class="modal-title mb-3" id="popupLabel"></h5>

                    <!-- STEP 1 -->
                    <div id="boxStep1" class="p-4 p-md-5 w-100"
                        style="background-color: rgba(255,255,255,0.93); border-radius: 10px; max-width: 430px; width: 100%; box-shadow: 0 2px 16px 0 rgba(0,0,0,0.07); margin: 0 auto;">
                        <h3 class="fw-bold mb-3">Mai pi√π tempo perso.</h3>
                        <p class="mb-4 text-secondary">Supervisiona, gestisci e monitora gli orari dei tuoi
                            dipendenti in modo intelligente.</p>
                        <ul class="list-unstyled text-dark">
                            <li class="mb-2">‚úÖ Monitoraggio entrate/uscite in tempo reale</li>
                            <li class="mb-2">‚úÖ Report Excel dettagliati per il commercialista</li>
                            <li class="mb-2">‚úÖ Gestionale interattivo e intuitivo</li>
                            <li class="mb-4">‚úÖ Vista Calendarizzata per una gestione smart</li>
                        </ul>
                        <div class="d-flex flex-column align-items-center gap-2 mb-3">
                            <a href="/dashboard_demo"
                                class="btn btn-outline-danger px-4 py-2 fw-semibold w-100 w-md-auto"
                                style="min-width: 220px; border-radius: 5px;" target="_blank">Esplora DEMO</a>
                            <button id="btnProva30" type="button"
                                class="btn btn-danger px-4 py-2 fw-semibold w-100 w-md-auto"
                                style="min-width: 220px; border-radius: 5px;">Prova Gratis 30 giorni</button>
                        </div>
                        <p class="small text-muted text-center mb-0" style="font-size: 0.65rem;">Annulla in
                            qualsiasi momento, ti invieremo un promemoria prima della scadenza del periodo di
                            prova.</p>
                    </div>

                    <!-- STEP 2 (inizialmente nascosto) -->
                    <div id="step2" style="display: none;" class="p-4 p-md-5 bg-white bg-opacity-90 rounded">
                        <!-- Step Indicator -->
                        <div class="d-flex align-items-center justify-content-start gap-4 mb-4 flex-wrap">
                            <div class="step active">
                                <div class="circle">1</div>
                                <div class="label"><strong>Dati</strong></div>
                            </div>
                            <div class="divider"></div>
                            <div class="step current">
                                <div class="circle">2</div>
                                <div class="label">Revisione</div>
                            </div>
                            <div class="divider"></div>
                            <div class="step current">
                                <div class="circle">3</div>
                                <div class="label">Fine</div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- COLONNA SINISTRA -->
                            <div class="col-12 col-md-6">
                                <label class="form-label mb-3">Seleziona il numero dei dipendenti:</label>
                                <select class="form-select mb-4 rounded" id="numeroDipendenti">
                                    <option value="5">da 1 a 5 Dipendenti</option>
                                    <option value="11">da 6 a 11 dipendenti</option>
                                    <option value="99999">Pi√π di 12 dipendenti</option>
                                </select>

                                <div class="mb-3">
                                    <label for="email" class="form-label">La tua migliore mail</label>
                                    <input type="email" id="email" class="form-control rounded"
                                        placeholder="esempio@azienda.it" required>
                                    <div class="fst-italic small">Riceverai qui il tuo QR Code</div>
                                </div>

                                <div class="mb-4">
                                    <label for="telefono" class="form-label">Telefono</label>
                                    <input type="tel" id="telefono" class="form-control rounded"
                                        placeholder="+39 333 1234567" required>
                                    <div class="fst-italic small">Non lo utilizzeremo mai a scopo promozionale
                                    </div>
                                </div>

                                <div class="d-grid d-none d-md-block">
                                    <button type="button" class="btn btn-danger rounded" onclick="vaiStep3()">Attiva
                                        Prova
                                        Gratuita</button>
                                </div>
                            </div>

                            <!-- COLONNA DESTRA -->
                            <div class="col-12 col-md-6 ps-md-4 pt-4 pt-md-0">
                                <!-- Card GPS -->
                                <div class="mb-4">
                                    <div class="d-flex align-items-start gap-2 mb-2">
                                        <img src="https://img.icons8.com/office/40/worldwide-location--v1.png"
                                            alt="icona" style="width: 25px; height: 25px;">
                                        <div class="fw-bold" style="font-size: 1.3rem;">Localizzazione GPS</div>
                                    </div>
                                    <p class="mb-0">Attiva la rilevazione della posizione al dispositivo quando
                                        si effettua lo scan di
                                        entrata o di uscita</p>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="GPSCheckbox">
                                        <label class="form-check-label" for="GPSCheckbox">Attiva GPS</label>
                                    </div>
                                    <hr class="my-3" style="border-top: 1px solid #ccc;">
                                </div>

                                <!-- Card Interscambio -->
                                <div>
                                    <div class="d-flex align-items-start gap-2 mb-2">
                                        <img src="https://img.icons8.com/ultraviolet/40/change-user-male.png"
                                            alt="icona" style="width: 25px; height: 25px;">
                                        <div class="fw-bold" style="font-size: 1.3rem;">Interscambio</div>
                                    </div>
                                    <p class="mb-0">Permette ai dipendenti di scannerizzare pi√π QR Code. Utile
                                        per situazioni simili a
                                        cantieri dislocati in diverse posizioni</p>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="interscambioCheckbox">
                                        <label class="form-check-label" for="interscambioCheckbox">Attiva
                                            Interscambio</label>
                                    </div>
                                </div>

                                <div class="d-grid d-block d-md-none mt-4">
                                    <button type="button" class="btn btn-danger rounded" onclick="vaiStep3()">Attiva
                                        Prova
                                        Gratuita</button>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- STEP 3 -->
                    <div id="step3" style="display: none;" class="p-4 p-md-5 bg-white bg-opacity-90 rounded">
                        <!-- Step Indicator (in alto, centrato) -->
                        <div class="d-flex align-items-center justify-content-start gap-4 mb-4 flex-wrap">
                            <div class="step current">
                                <div class="circle">1</div>
                                <div class="label"><strong>Dati</strong></div>
                            </div>
                            <div class="divider"></div>
                            <div class="step active">
                                <div class="circle">2</div>
                                <div class="label"><strong>Revisione</strong></div>
                            </div>
                            <div class="divider"></div>
                            <div class="step current">
                                <div class="circle">3</div>
                                <div class="label"><strong>Fine</strong></div>
                            </div>
                        </div>
                        <!-- Titolo centrato -->
                        <div class="text-center mb-4">
                            <h5 class="fw-bold mb-1" style="font-size: 1.0rem;">Prova TeamTime gratis per 30
                                giorni.
                            </h5>
                        
                        </div>
                        <!-- LAPTOP Progress bar orizzontale subito sotto il titolo -->
                        <div class="mb-4">
                            <div class="d-none d-md-flex align-items-center justify-content-between" style="gap: 0.5rem;">
                                <!-- Step 1 -->
                                <div class="d-flex flex-column align-items-center" style="flex:1;">
                                    <img src="https://img.icons8.com/?size=100&id=ObnBoaCt9lCV&format=png&color=000000" alt="Step 1"
                                        style="width: 28px; height: 28px;">
                                    <div class="fw-bold" style="font-size: 0.85rem;">Ricevi Oggi</div>
                                    <div style="font-size: 0.7rem; color: #444;">QR Code via mail</div>
                                </div>
                        
                                <!-- üî¥ Testo sopra barra -->
                                <div class="text-center" style="flex:2;">
                                    <div style="font-size: 0.65rem; color: #666;">Dopo 23 giorni</div>
                                    <div
                                        style="height: 4px; background: linear-gradient(to right, #ff1744 0%, #ff1744 0%, #ddd 20%, #ddd 100%); border-radius: 2px;">
                                    </div>
                                </div>
                        
                                <!-- Step 2 -->
                                <div class="d-flex flex-column align-items-center" style="flex:1;">
                                    <img src="https://img.icons8.com/?size=100&id=xLIkjgcmFOsC&format=png&color=000000" alt="Step 2"
                                        style="width: 28px; height: 28px;">
                                    <div class="fw-bold" style="font-size: 0.85rem;">Promemoria</div>
                                    <div style="font-size: 0.7rem; color: #444;">Via mail</div>
                                </div>
                        
                                <!-- üî¥ Testo sopra barra -->
                                <div class="text-center" style="flex:2;">
                                    <div style="font-size: 0.65rem; color: #666;">Dopo altri 7 giorni</div>
                                    <div
                                        style="height: 4px; background: linear-gradient(to right, #ff1744 0%, #ff1744 0%,  #ddd 0%, #ddd 100%); border-radius: 2px;">
                                    </div>
                                </div>
                        
                                <!-- Step 3 -->
                                <div class="d-flex flex-column align-items-center" style="flex:1;">
                                    <img src="https://img.icons8.com/?size=100&id=lWWE908jTJ3m&format=png&color=000000" alt="Step 3"
                                        style="width: 28px; height: 28px;">
                                    <div class="fw-bold" style="font-size: 0.85rem;">Abbonamento</div>
                                    <div style="font-size: 0.60rem; color: #444;">Pagamento Annuale</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- MOBILE Progress bar-->
                        <img src="{{ url_for('static', filename='img/img/mobile_payment_flow.png') }}" alt="App Registro Presenze"
                            class="d-block d-md-none img-fluid mb-3" style="max-width: 100%; height: auto;">
                        
                        <!-- LAPTOP Box riepilogo e pagamento affiancati -->
                        <div class="d-none d-md-flex justify-content-between flex-row mb-4" style="align-items: stretch; gap: 2.5%;">
                            <!-- Colonna sinistra: Box pagamento -->
                            <div style="width: 60%; min-width: 260px; display: flex; flex-direction: column;">
                                <div class="border rounded p-4 mb-0 d-flex flex-column align-items-center justify-content-center flex-fill"
                                    style="background-color: rgba(255,255,255,0.9); width: 100%; border-radius: 5px; max-width: 400px; margin: 0 auto; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.04); flex: 1 1 0; min-height: 0; overflow: auto;">
                        
                                    <!-- Contenitore Form Stripe -->
                                    <form id="payment-form" style="width: 100%; max-width: 340px;">
                                        <div class="d-flex align-items-center justify-content-between mb-1">
                                            <label for="card-element" class="form-label mb-0" style="font-size: 0.75rem;">Intestatario
                                                Carta</label>
                                            <div class="stripe-secure-text d-flex align-items-center"
                                                style="font-size: 0.7rem; color: #555; gap: 0.3rem;">
                                                <a href="https://support.stripe.com/questions/is-my-financial-account-information-safe?locale=it-IT"
                                                    style="font-size: 0.65rem; color: #635BFF; text-decoration: underline; font-weight: 400; display: inline-flex; align-items: center; gap: 4px;"
                                                    target="_blank">
                                                    Dati sicuri con
                                                </a>
                                                <div
                                                    style="background-color: #635BFF; padding: 0.2px 7px; border-radius: 8px; display: inline-block;">
                                                    <span
                                                        style="color: #fff; font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 700; letter-spacing: -1px;">
                                                        stripe
                                                    </span>
                                                </div>
                                            </div>
                        
                        
                                        </div>
                        
                                        <div class="mb-3 d-flex gap-2">
                                            <div style="flex:1;">
                                                <input type="text" class="form-control" id="cardFirstName" placeholder="Nome"
                                                    style="font-size: 0.95rem; height: 44px; border-radius: 6px;" required>
                                            </div>
                                            <div style="flex:1;">
                                                <input type="text" class="form-control" id="cardLastName" placeholder="Cognome"
                                                    style="font-size: 0.95rem; height: 44px; border-radius: 6px;" required>
                                            </div>
                                        </div>
                        
                                        <div class="mb-3">
                                            <div id="card-element"
                                                style="border: 1px solid #ced4da; border-radius: 6px; padding: 10px 12px; height: 44px;">
                                                <!-- Stripe inserir√† qui il campo carta -->
                                            </div>
                                        </div>
                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="isBusiness">
                                            <label class="form-check-label" for="isBusiness" style="font-size: 0.75rem;">Stai acquistando
                                                come
                                                azienda?</label>
                                        </div>
                        
                                        <div id="businessFields" style="display: none;">
                                            <div class="mb-3 d-flex gap-2">
                                                <div style="flex:1;">
                                                    <input type="text" id="companyName" class="form-control" placeholder="Ragione Sociale"
                                                        style="font-size: 0.95rem; height: 44px; border-radius: 6px;" required>
                                                </div>
                                                <div style="flex:1;">
                                                    <input type="text" id="vatNumber" class="form-control" placeholder="Partita IVA"
                                                        style="font-size: 0.95rem; height: 44px; border-radius: 6px;" required>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <input type="text" id="companyAddress" class="form-control" placeholder="Indirizzo aziendale"
                                                    style="font-size: 0.95rem; height: 44px; border-radius: 6px;" required>
                                            </div>
                                        </div>
                        
                                        <div id="card-errors" role="alert" class="text-danger mt-2" style="font-size: 0.6rem;"></div>
                        
                                        <div class="text-center mt-3 d-flex flex-column align-items-center justify-content-center w-100">
                                            <button id="attivaProvaBtn" class="btn btn-danger px-5 py-2 fw-semibold"
                                                style="font-size: 0.95rem; border-radius: 5px; min-width: 220px;" type="button">
                                                Attiva Prova Gratuita
                                                <img src="https://img.icons8.com/?size=100&id=BliA0IHNvACv&format=png&color=000000"
                                                    alt="Stripe Icon" style="width: 30px; height: 30px; margin-left: 6px;" />
                                            </button>
                        
                                            <div id="spinnerSectionStep3" class="spinner-border text-danger" role="status"
                                                style="width: 1.5rem; height: 1.5rem; display: none;">
                                            </div>
                                        </div>
                                    </form>
                        
                                    <script>
                                        const stripe = Stripe('pk_test_51HQrXLEF8NjwgIEOCRLexg5Kb1y7rleJlbG8fHJ7yQ8L26Wy5Ps9Jz3XFFhtcCGCcq2loYG4pUoTBjRGjM4acOGr00XREbmlA0'); // La tua public key**
                                        const elements = stripe.elements();
                                        const card = elements.create('card', {
                                            style: {
                                                base: {
                                                    fontSize: '16px',
                                                    color: '#32325d',
                                                    fontFamily: 'Arial, sans-serif',
                                                    '::placeholder': { color: '#aab7c4' }
                                                },
                                                invalid: {
                                                    color: '#fa755a',
                                                    iconColor: '#fa755a'
                                                }
                                            }
                                        });
                                        card.mount('#card-element');

                                        document.getElementById('attivaProvaBtn').onclick = async () => {
                                            const btn = document.getElementById('attivaProvaBtn');
                                            const spinner = document.getElementById('spinnerSectionStep3');
                                            // Validazione campi Nome e Cognome
                                            const firstName = document.getElementById('cardFirstName').value.trim();
                                            const lastName = document.getElementById('cardLastName').value.trim();
                                            if (!firstName || !lastName) {
                                                document.getElementById('card-errors').textContent = 'Compila tutti i campi.';
                                                spinner.style.display = 'none';
                                                btn.disabled = false;
                                                return;
                                            }
                                            // Validazione campi aziendali se selezionato
                                            const isBusiness = document.getElementById('isBusiness').checked;
                                            let companyName = '', vatNumber = '', companyAddress = '';
                                            if (isBusiness) {
                                                companyName = document.getElementById('companyName').value.trim();
                                                vatNumber = document.getElementById('vatNumber').value.trim();
                                                companyAddress = document.getElementById('companyAddress').value.trim();
                                                if (!companyName || !vatNumber || !companyAddress) {
                                                    document.getElementById('card-errors').textContent = 'Compila tutti i dati aziendali.';
                                                    spinner.style.display = 'none';
                                                    btn.disabled = false;
                                                    return;
                                                }
                                            }
                                            document.getElementById('card-errors').textContent = '';
                                            btn.disabled = true;
                                            spinner.style.display = 'inline-block';

                                            const email = window.email_cliente || document.getElementById('email').value.trim();

                                            // Crea metodo di pagamento
                                            const { paymentMethod, error: setupError } = await stripe.createPaymentMethod({
                                                type: 'card',
                                                card: card,
                                                billing_details: { email: email }
                                            });

                                            if (setupError) {
                                                alert(setupError.message);
                                                return;
                                            }

                                            // Determina il piano corretto al momento del pagamento
                                            let piano = "START";
                                            if (window.dipendenti_cliente === "11") {
                                                piano = "TEAMS";
                                            } else if (window.dipendenti_cliente === "99999") {
                                                piano = "BUSINESS";
                                            }
                                            window.piano_cliente = piano;


                                            // Invia al server per creare sottoscrizione
                                            const res = await fetch('/create-subscription', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({
                                                    email: email,
                                                    payment_method: paymentMethod.id,
                                                    piano: window.piano_cliente,              // oppure "TEAMS" o "BUSINESS"
                                                    gps: window.gps_cliente,     // "yes" o "no"
                                                    interscambio: window.interscambio_cliente, // "yes" o "no"
                                                    ragionesociale_cliente: companyName || undefined,
                                                    partitaiva_cliente: vatNumber || undefined,
                                                    indirizzo_cliente: companyAddress || undefined
                                                })
                                            });

                                            const data = await res.json();
                                            window.customer_id_stripe = data.customerId;

                                            // Se √® una prova gratuita, clientSecret sar√† null
                                            if (!data.clientSecret) {
                                                // alert("Prova gratuita attivata con successo!");
                                                vaiStep4();
                                                // document.getElementById('step4').style.display = 'block';
                                                return;
                                            }

                                            // Altrimenti conferma il pagamento
                                            const result = await stripe.confirmCardPayment(data.clientSecret);

                                            if (result.error) {
                                                alert("Errore pagamento: " + result.error.message);
                                            } else {
                                                alert("Iscrizione attivata con successo!");
                                                // puoi proseguire al prossimo step
                                            }
                                        };
                                    </script>
                        
                                </div>
                            </div>
                            <!-- Colonna destra: Box riepilogo -->
                            <div style="width: 38%; min-width: 220px; display: flex; flex-direction: column;">
                                <div class="border rounded p-4 mb-0 d-flex flex-column justify-content-between h-100 riepilogo-box-fix d-grid d-none d-md-block"
                                    style="background-color: rgba(255,255,255,0.9); width: 100%; border-radius: 5px; flex: 1 1 0; min-height: 100%; box-sizing: border-box; overflow: auto;">
                        
                                    <!-- Titolo -->
                        
                                    <span class="badge bg-success mb-3" style="font-size: 0.6rem;">Nessun
                                        pagamento oggi</span>
                        
                                    <!-- Dipendenti -->
                                    <div class="mb-3" style="font-size: 0.85rem;">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="d-flex flex-column">
                                                <strong>Dipendenti:</strong>
                                                <span id="riepilogoDipendenti" style="font-size: 0.75rem; color: #444;">Da 1 a 5</span>
                                            </div>
                                            <div class="d-flex flex-column text-end">
                                                <span id="prezzoDipendenti">99,00‚Ç¨</span>
                                                <span style="font-size: 0.75rem; color: #444;">annuali</span>
                                            </div>
                                        </div>
                                    </div>
                        
                                    <!-- GPS -->
                                    <div class="mb-3" style="font-size: 0.85rem;">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="d-flex flex-column">
                                                <strong>Rilevazione GPS:</strong>
                                                <span id="riepilogoGPS" style="font-size: 0.75rem; color: #444;">Attivo</span>
                                            </div>
                                            <div class="d-flex flex-column text-end">
                                                <span id="prezzoGPS">0,00‚Ç¨</span>
                                                <span style="font-size: 0.75rem; color: #444;">annuali</span>
                                            </div>
                                        </div>
                                    </div>
                        
                                    <!-- Interscambio -->
                                    <div class="mb-3" style="font-size: 0.85rem;">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="d-flex flex-column">
                                                <strong>Interscambio:</strong>
                                                <span id="riepilogoInterscambio" style="font-size: 0.75rem; color: #444;">Non Attivo</span>
                                            </div>
                                            <div class="d-flex flex-column text-end">
                                                <span id="prezzoInterscambio">0,00‚Ç¨</span>
                                                <span style="font-size: 0.75rem; color: #444;">annuali</span>
                                            </div>
                                        </div>
                                    </div>
                        
                                    <hr>
                        
                                    <!-- Da pagare -->
                                    <div class="d-flex justify-content-between mb-3" style="font-size: 0.95rem;">
                                        <strong>Da pagare oggi</strong><strong style="color: green;">0,00
                                            ‚Ç¨</strong>
                                    </div>
                                    <!-- Totale -->
                                    <div class="d-flex justify-content-between mb-1" style="font-size: 0.8rem; color: #999;">
                                        <span>Totale</span><span id="totaleImporto">324,00‚Ç¨</span>
                                    </div>
                        
                        
                                    <!-- Info prova -->
                                    <div style="font-size: 0.7rem; color: #555;">
                                        ‚úÖ Annulla quando vuoi. Non pagherai nulla fino al <strong id="fineProvaData"></strong>, poi si
                                        attiver√† l'abbonamento con
                                        cadenza annuale.
                                    </div>
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-outline-danger px-3 py-1 fw-normal w-auto"
                                            style="width: 100%; border-radius: 4px; font-size: 0.8rem; opacity: 0.6;" onclick="vaiStep2()">
                                            Modifica
                                        </button>
                                    </div>
                        
                        
                        
                                </div>
                            </div>
                        </div>
                        
                        <!-- MOBILE Box Riepilogo VERSIONE MOBILE (< md) -->
                        <div class="d-block d-md-none mb-4"
                            style="width: 100%; display: flex; flex-direction: column; gap: 1.5rem; padding: 0; margin: 0;">
                            <div style="width: 100%; display: flex; flex-direction: column; padding: 0; margin: 0;">
                                <div class="border rounded p-4 mb-0 d-flex flex-column align-items-center justify-content-center flex-fill"
                                    style="background-color: rgba(255,255,255,0.9); width: 100%; box-shadow: 0 2px 12px rgba(0,0,0,0.04);">
                                     <!-- Contenitore Form Stripe -->
                        
                                    <span class="badge bg-success mb-3" style="font-size: 0.6rem;">Nessun
                                        pagamento oggi
                                    </span>
                        
                        
                                    <!-- Riepilogo sintetico ordinato a tutta larghezza -->
                                    <div class="mb-3" style="font-size: 0.85rem;">
                                        <!-- Dipendenti -->
                                        <div class="d-flex mb-2 w-100">
                                            <div class="text-start" style="flex: 1;">
                                                <strong>Dipendenti</strong><br>
                                                <span id="riepilogoDipendenti" style="font-size: 0.75rem; color: #444;">Da 1 a 5</span>
                                            </div>
                                            <div class="text-end" style="flex: 1;">
                                                <span id="prezzoDipendenti">99,00‚Ç¨</span><br>
                                                <span style="font-size: 0.75rem; color: #444;">annuali</span>
                                            </div>
                                        </div>
                        
                                        <!-- GPS -->
                                        <div class="d-flex mb-2 w-100">
                                            <div class="text-start" style="flex: 1;">
                                                <strong>Rilevazione GPS</strong><br>
                                                <span id="riepilogoGPS" style="font-size: 0.75rem; color: #444;">Attivo</span>
                                            </div>
                                            <div class="text-end" style="flex: 1;">
                                                <span id="prezzoGPS">0,00‚Ç¨</span><br>
                                                <span style="font-size: 0.75rem; color: #444;">annuali</span>
                                            </div>
                                        </div>
                        
                                        <!-- Interscambio -->
                                        <div class="d-flex w-100">
                                            <div class="text-start" style="flex: 1;">
                                                <strong>Interscambio</strong><br>
                                                <span id="riepilogoInterscambio" style="font-size: 0.75rem; color: #444;">Non Attivo</span>
                                            </div>
                                            <div class="text-end" style="flex: 1;">
                                                <span id="prezzoInterscambio">0,00‚Ç¨</span><br>
                                                <span style="font-size: 0.75rem; color: #444;">annuali</span>
                                            </div>
                                        </div>
                                    </div>
                        
                        
                        
                                    <hr>
                        
                                    <!-- Da pagare -->
                                    <div class="d-flex justify-content-between align-items-center w-100 mb-3 px-2"
                                        style="font-size: 0.80rem; white-space: nowrap;">
                                        <strong class="mb-0">Da pagare oggi:</strong>
                                        <strong class="mb-0" style="color: green;">0,00 ‚Ç¨</strong>
                                    </div>
                                    
                                    
                                    <!-- Totale -->
                                    <div class="d-flex justify-content-between align-items-center w-100 mb-1 px-2" style="font-size: 0.8rem; color: #999;">
                                        <span class="text-start" style="flex: 1;">Totale:</span>
                                        <span id="totaleImporto" class="text-end" style="flex: 1;">324,00‚Ç¨</span>
                                    </div>
                                    
                        
                        
                                    <!-- Info prova -->
                                    <div style="font-size: 0.7rem; color: #555;">
                                        ‚úÖ Annulla quando vuoi. Non pagherai nulla fino al <strong id="fineProvaData"></strong>, poi si
                                        attiver√† l'abbonamento con
                                        cadenza annuale.
                                    </div>
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-outline-danger px-3 py-1 fw-normal w-auto"
                                            style="width: 100%; border-radius: 4px; font-size: 0.8rem; opacity: 0.6;" onclick="vaiStep2()">
                                            Modifica
                                        </button>
                                    </div>
                        
                                </div>
                            </div>
                        
                            <!-- Colonna 2: Box riepilogo (mobile) -->
                            <div style="width: 100%; display: flex; flex-direction: column;">
                                <div class="border rounded p-4 mb-0 d-flex flex-column justify-content-between riepilogo-box-fix"
                                    style="background-color: rgba(255,255,255,0.9); width: 100%; border-radius: 5px; box-sizing: border-box; overflow: auto;">
                                    <!-- Puoi copiare qui tutto il contenuto del box riepilogo -->
                                    <form id="payment-form" style="width: 100%; max-width: 340px;">
                                        <div class="d-flex align-items-center justify-content-between mb-1">
                                            <label for="card-element" class="form-label mb-0" style="font-size: 0.75rem;">Intestatario
                                                Carta
                                            </label>
                                        </div>
                        
                                        <div class="mb-3 d-flex gap-2">
                                            <div style="flex:1;">
                                                <input type="text" class="form-control" id="cardFirstName" placeholder="Nome"
                                                    style="font-size: 0.95rem; height: 44px; border-radius: 6px;" required>
                                            </div>
                                            <div style="flex:1;">
                                                <input type="text" class="form-control" id="cardLastName" placeholder="Cognome"
                                                    style="font-size: 0.95rem; height: 44px; border-radius: 6px;" required>
                                            </div>
                                        </div>
                        
                                        <div class="mb-3">
                                            <label for="card-element" class="form-label mb-0" style="font-size: 0.75rem;">Dati Carta
                                            </label>
                                            <div id="card-element"
                                                style="border: 1px solid #ced4da; border-radius: 6px; padding: 10px 12px; height: 44px;">
                                                <!-- Stripe inserir√† qui il campo carta -->
                                            </div>
                                        </div>
                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="isBusiness">
                                            <label class="form-check-label" for="isBusiness" style="font-size: 0.75rem;">Stai acquistando
                                                come
                                                azienda?</label>
                                        </div>
                        
                                        <div id="businessFields" style="display: none;">
                                            <div class="mb-3 d-flex gap-2">
                                                <div style="flex:1;">
                                                    <input type="text" id="companyName" class="form-control" placeholder="Ragione Sociale"
                                                        style="font-size: 0.95rem; height: 44px; border-radius: 6px;" required>
                                                </div>
                                                <div style="flex:1;">
                                                    <input type="text" id="vatNumber" class="form-control" placeholder="Partita IVA"
                                                        style="font-size: 0.95rem; height: 44px; border-radius: 6px;" required>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <input type="text" id="companyAddress" class="form-control" placeholder="Indirizzo aziendale"
                                                    style="font-size: 0.95rem; height: 44px; border-radius: 6px;" required>
                                            </div>
                                        </div>
                        
                                        <div id="card-errors" role="alert" class="text-danger mt-2" style="font-size: 0.6rem;"></div>
                        
                                    </form>
                        
                                    <div class="text-center mt-3 d-flex flex-column align-items-center justify-content-center w-100">
                                        <button id="attivaProvaBtn" class="btn btn-danger px-5 py-2 fw-semibold"
                                            style="font-size: 0.95rem; border-radius: 5px; min-width: 220px;" type="button">
                                            Attiva Gratis
                                        </button>
                                        <hr>
                                        <div class="stripe-secure-text d-flex align-items-center"
                                            style="font-size: 0.7rem; color: #555; gap: 0.3rem;">
                                            <a href="https://support.stripe.com/questions/is-my-financial-account-information-safe?locale=it-IT"
                                                style="font-size: 0.65rem; color: #635BFF; text-decoration: underline; font-weight: 400; display: inline-flex; align-items: center; gap: 4px;"
                                                target="_blank">
                                                Pagamento sicuro con
                                            </a>
                                            <div
                                                style="background-color: #635BFF; padding: 0.2px 7px; border-radius: 8px; display: inline-block;">
                                                <span
                                                    style="color: #fff; font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 700; letter-spacing: -1px;">
                                                    stripe
                                                </span>
                                            </div>
                                        </div>
                        
                                        <div id="spinnerSectionStep3" class="spinner-border text-danger" role="status"
                                            style="width: 1.5rem; height: 1.5rem; display: none;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ‚úÖ Bootstrap JS Bundle (con Popper incluso) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ‚úÖ Apertura Modal al caricamento
        document.addEventListener("DOMContentLoaded", function () {
            const popupEl = document.getElementById("popup");
            const popupModal = bootstrap.Modal.getOrCreateInstance(popupEl);
            popupModal.show();

            // ‚úÖ Prevenzione chiusura su click sfondo
            popupEl.addEventListener("hide.bs.modal", function (e) {
                e.preventDefault();
                console.warn("‚õîÔ∏è Modal vuole chiudersi ‚Üí BLOCCATO");
            });

            // ‚úÖ Prevenzione submit accidentale
            document.getElementById("step1").addEventListener("submit", function (e) {
                e.preventDefault();
                console.log("‚õîÔ∏è Submit del form intercettato");
            });

            // ‚úÖ Bottone "Prova Gratis"
            document.getElementById("btnProva30").addEventListener("click", function (e) {
                console.log("üß™ CLICK su btnProva30 ‚Üí vaiStep2()");
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                vaiStep2();
            });
        });

        // ‚úÖ Logica degli step
        function vaiStep2() {
            console.log("‚úÖ FUNZIONE vaiStep2 CHIAMATA");
            document.getElementById('boxStep1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            document.getElementById('step3').style.display = 'none';
        }

        function vaiStep3() {
            console.log("‚úÖ FUNZIONE vaiStep3 CHIAMATA");
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'block';
        }
    </script>

</body>

<!-- Core JS -->
<!-- build:js /vendor/js/core.js -->
<script src="/static/vendor/libs/jquery/jquery.js"></script>
<script src="/static/vendor/libs/popper/popper.js"></script>
<script src="/static/vendor/js/bootstrap.js"></script>
<script src="/static/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
<script src="/static/vendor/js/menu.js"></script>
<!-- endbuild -->

<!-- Vendors JS -->
<script src="/static/vendor/libs/apex-charts/apexcharts.js"></script>

<!-- Main JS -->
<script src="/static/js/main.js"></script>

<!-- Page JS -->
<script src="/static/js/dashboards-analytics.js"></script>

<!-- Place this tag in your head or just before your close body tag. -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

</html>